{{ $contentId := .Get "id" | default "content-1" }}
{{ $content := .Inner }}
{{ $secret := .Get "secret" | default "JBSWY3DPEHPK3PXP" }}

<div class="totp-password-protected" data-content-id="{{ $contentId }}" data-secret="{{ $secret }}">
  <div class="password-form">
    <div class="password-header">
      <div class="lock-icon">ğŸ”</div>
      <h3>åŠ¨æ€å¯†ç éªŒè¯</h3>
      <p>è¯·è¾“å…¥å½“å‰æ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç </p>
    </div>
    <div class="password-input-group">
      <input type="text" placeholder="6ä½æ•°å­—å¯†ç " class="password-field" autocomplete="off" maxlength="6" pattern="[0-9]{6}">
      <button onclick="verifyTOTP(this)" class="unlock-btn">éªŒè¯</button>
    </div>
    <div class="password-hint">
      <small>â° å¯†ç æ¯30ç§’æ›´æ–°ä¸€æ¬¡ï¼Œè¯·ä½¿ç”¨æœ€æ–°å¯†ç </small>
    </div>
    <div class="time-remaining">
      <small>å‰©ä½™æ—¶é—´: <span class="countdown">30</span>ç§’</small>
    </div>
  </div>
  
  <div class="protected-content" style="display: none;">
    <div class="content-header">
      <span class="unlock-icon">âœ…</span>
      <span class="unlock-text">éªŒè¯æˆåŠŸï¼Œå†…å®¹å·²è§£é”</span>
    </div>
    <div class="content-body">
      {{ $content }}
    </div>
  </div>
</div>

<style>
.totp-password-protected {
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  margin: 2rem 0;
  overflow: hidden;
  transition: all 0.3s ease;
  background: #fafafa;
}

.totp-password-protected.verified {
  border-color: #10b981;
  background: #f0fdf4;
}

.password-form {
  padding: 2rem;
  text-align: center;
  background: #f9fafb;
}

.password-header {
  margin-bottom: 1.5rem;
}

.lock-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  display: block;
  color: #3b82f6;
}

.password-header h3 {
  margin: 0 0 0.5rem 0;
  color: #374151;
  font-size: 1.25rem;
}

.password-header p {
  margin: 0;
  color: #6b7280;
  font-size: 0.9rem;
}

.password-input-group {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  margin-bottom: 1rem;
  max-width: 300px;
  margin-left: auto;
  margin-right: auto;
}

.password-field {
  flex: 1;
  padding: 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 0.9rem;
  outline: none;
  transition: border-color 0.2s ease;
  text-align: center;
  font-family: monospace;
  font-size: 1.2rem;
  letter-spacing: 0.2em;
}

.password-field:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.unlock-btn {
  padding: 0.75rem 1.5rem;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.unlock-btn:hover {
  background: #2563eb;
}

.unlock-btn:active {
  transform: translateY(1px);
}

.password-hint {
  color: #6b7280;
  font-size: 0.8rem;
  margin-bottom: 0.5rem;
}

.time-remaining {
  color: #3b82f6;
  font-size: 0.8rem;
  font-weight: 500;
}

.countdown {
  font-weight: bold;
  color: #ef4444;
}

.protected-content {
  padding: 1.5rem;
}

.content-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #e5e7eb;
  color: #10b981;
  font-weight: 500;
}

.unlock-icon {
  font-size: 1.2rem;
}

.content-body {
  line-height: 1.6;
}

/* é”™è¯¯çŠ¶æ€ */
.password-field.error {
  border-color: #ef4444;
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.unlock-btn.error {
  background: #ef4444;
}

.unlock-btn.error:hover {
  background: #dc2626;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 640px) {
  .password-input-group {
    flex-direction: column;
  }
  
  .password-field {
    margin-bottom: 0.5rem;
  }
}
</style>

<script>
// TOTP å®ç° (åŸºäº RFC 6238)
class TOTP {
  constructor(secret) {
    this.secret = secret;
  }

  // Base32 è§£ç 
  base32Decode(str) {
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    let bits = 0;
    let value = 0;
    let output = '';

    for (let i = 0; i < str.length; i++) {
      const c = str[i].toUpperCase();
      const index = alphabet.indexOf(c);
      if (index === -1) continue;

      value = (value << 5) | index;
      bits += 5;

      if (bits >= 8) {
        output += String.fromCharCode((value >>> (bits - 8)) & 0xFF);
        bits -= 8;
      }
    }
    return output;
  }

  // HMAC-SHA1
  async hmacSha1(key, message) {
    const keyBuffer = new TextEncoder().encode(key);
    const messageBuffer = new TextEncoder().encode(message);
    
    const cryptoKey = await crypto.subtle.importKey(
      'raw',
      keyBuffer,
      { name: 'HMAC', hash: 'SHA-1' },
      false,
      ['sign']
    );
    
    const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageBuffer);
    return new Uint8Array(signature);
  }

  // ç”Ÿæˆ TOTP
  async generateTOTP(time = Math.floor(Date.now() / 1000)) {
    const secret = this.base32Decode(this.secret);
    const timeBuffer = new ArrayBuffer(8);
    const timeView = new DataView(timeBuffer);
    timeView.setBigUint64(0, BigInt(Math.floor(time / 30)), false);

    const hmac = await this.hmacSha1(secret, timeBuffer);
    const offset = hmac[hmac.length - 1] & 0x0F;
    const code = ((hmac[offset] & 0x7F) << 24) |
                 ((hmac[offset + 1] & 0xFF) << 16) |
                 ((hmac[offset + 2] & 0xFF) << 8) |
                 (hmac[offset + 3] & 0xFF);

    return (code % 1000000).toString().padStart(6, '0');
  }
}

// å…¨å±€ TOTP å®ä¾‹
let totpInstance = null;

// éªŒè¯ TOTP
async function verifyTOTP(button) {
  const container = button.closest('.totp-password-protected');
  const passwordField = container.querySelector('.password-field');
  const secret = container.dataset.secret;
  const protectedContent = container.querySelector('.protected-content');
  const passwordForm = container.querySelector('.password-form');
  
  // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯çŠ¶æ€
  passwordField.classList.remove('error');
  button.classList.remove('error');
  
  // åˆå§‹åŒ– TOTP
  if (!totpInstance) {
    totpInstance = new TOTP(secret);
  }
  
  // ç”Ÿæˆå½“å‰æ—¶é—´çš„ TOTP
  const currentTOTP = await totpInstance.generateTOTP();
  const inputTOTP = passwordField.value;
  
  if (inputTOTP === currentTOTP) {
    // éªŒè¯æˆåŠŸ
    passwordForm.style.display = 'none';
    protectedContent.style.display = 'block';
    container.classList.add('verified');
    
    // æ·»åŠ æˆåŠŸåŠ¨ç”»
    protectedContent.style.opacity = '0';
    protectedContent.style.transform = 'translateY(10px)';
    setTimeout(() => {
      protectedContent.style.transition = 'all 0.3s ease';
      protectedContent.style.opacity = '1';
      protectedContent.style.transform = 'translateY(0)';
    }, 100);
    
  } else {
    // éªŒè¯å¤±è´¥
    passwordField.classList.add('error');
    button.classList.add('error');
    passwordField.value = '';
    passwordField.focus();
    
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    const hint = container.querySelector('.password-hint');
    hint.innerHTML = '<small style="color: #ef4444;">âŒ å¯†ç é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ—¶é—´å¹¶é‡è¯•</small>';
    
    // 3ç§’åæ¢å¤åŸæç¤º
    setTimeout(() => {
      hint.innerHTML = '<small>â° å¯†ç æ¯30ç§’æ›´æ–°ä¸€æ¬¡ï¼Œè¯·ä½¿ç”¨æœ€æ–°å¯†ç </small>';
    }, 3000);
  }
}

// æ›´æ–°å€’è®¡æ—¶
function updateCountdown() {
  const containers = document.querySelectorAll('.totp-password-protected');
  containers.forEach(container => {
    const countdownElement = container.querySelector('.countdown');
    if (countdownElement) {
      const now = Math.floor(Date.now() / 1000);
      const remaining = 30 - (now % 30);
      countdownElement.textContent = remaining;
      
      // å½“æ—¶é—´æ¥è¿‘ç»“æŸæ—¶æ”¹å˜é¢œè‰²
      if (remaining <= 5) {
        countdownElement.style.color = '#ef4444';
      } else {
        countdownElement.style.color = '#3b82f6';
      }
    }
  });
}

// æ”¯æŒå›è½¦é”®éªŒè¯
document.addEventListener('DOMContentLoaded', function() {
  // å¯åŠ¨å€’è®¡æ—¶æ›´æ–°
  updateCountdown();
  setInterval(updateCountdown, 1000);
  
  document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      const activeElement = document.activeElement;
      if (activeElement && activeElement.classList.contains('password-field')) {
        const button = activeElement.nextElementSibling;
        if (button && button.classList.contains('unlock-btn')) {
          verifyTOTP(button);
        }
      }
    }
  });
});
</script>
