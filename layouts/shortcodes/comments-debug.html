{{/* Hugo è¯„è®ºç³»ç»ŸçŸ­ä»£ç  - è°ƒè¯•ç‰ˆæœ¬ */}}
<div class="comments-section" data-post-id="{{ .Page.RelPermalink }}" data-post-title="{{ .Page.Title }}">
  <h3>ğŸ’¬ è¯„è®º (è°ƒè¯•æ¨¡å¼)</h3>
  
  <!-- è°ƒè¯•ä¿¡æ¯ -->
  <div class="debug-info">
    <p><strong>é¡µé¢ä¿¡æ¯:</strong></p>
    <ul>
      <li>é¡µé¢è·¯å¾„: {{ .Page.RelPermalink }}</li>
      <li>é¡µé¢æ ‡é¢˜: {{ .Page.Title }}</li>
      <li>è¡¨å•ID: comment-form-{{ .Page.RelPermalink | md5 }}</li>
      <li>åˆ—è¡¨ID: comments-list-{{ .Page.RelPermalink | md5 }}</li>
    </ul>
  </div>
  
  <!-- è¯„è®ºè¡¨å• -->
  <div class="comment-form-container">
    <form class="comment-form" id="comment-form-{{ .Page.RelPermalink | md5 }}">
      <div class="form-group">
        <input type="text" name="author" placeholder="æ‚¨çš„å§“å *" required>
      </div>
      <div class="form-group">
        <input type="email" name="email" placeholder="æ‚¨çš„é‚®ç®± *" required>
      </div>
      <div class="form-group">
        <textarea name="content" placeholder="å†™ä¸‹æ‚¨çš„è¯„è®º... *" rows="4" required></textarea>
      </div>
      <button type="submit" class="submit-btn">
        <span class="btn-text">å‘è¡¨è¯„è®º</span>
        <span class="btn-loading" style="display: none;">å‘è¡¨ä¸­...</span>
      </button>
    </form>
  </div>
  
  <!-- è¯„è®ºåˆ—è¡¨ -->
  <div class="comments-list" id="comments-list-{{ .Page.RelPermalink | md5 }}">
    <div class="loading">æ­£åœ¨åŠ è½½è¯„è®º...</div>
  </div>
  
  <!-- è°ƒè¯•æ—¥å¿— -->
  <div class="debug-log" id="debug-log">
    <h4>è°ƒè¯•æ—¥å¿—</h4>
    <div id="log-content"></div>
  </div>
</div>

<style>
.comments-section {
  margin: 2rem 0;
  padding: 1.5rem;
  border: 1px solid #e1e5e9;
  border-radius: 8px;
  background: #fafbfc;
}

.debug-info {
  background: #e3f2fd;
  padding: 1rem;
  border-radius: 6px;
  margin-bottom: 1rem;
  font-size: 14px;
}

.debug-info ul {
  margin: 0.5rem 0;
  padding-left: 1.5rem;
}

.debug-info li {
  margin: 0.25rem 0;
}

.debug-log {
  margin-top: 2rem;
  padding: 1rem;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  font-family: monospace;
  font-size: 12px;
  max-height: 300px;
  overflow-y: auto;
}

.debug-log h4 {
  margin: 0 0 1rem 0;
  color: #495057;
}

#log-content {
  white-space: pre-wrap;
  line-height: 1.4;
}

.comment-form-container {
  margin-bottom: 2rem;
  padding: 1rem;
  background: white;
  border-radius: 6px;
  border: 1px solid #e1e5e9;
}

.comment-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group input,
.form-group textarea {
  padding: 0.75rem;
  border: 1px solid #d1d5da;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.15s ease-in-out;
}

.form-group input:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #0366d6;
  box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
}

.submit-btn {
  background: #2ea44f;
  color: white;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.15s ease-in-out;
  align-self: flex-start;
}

.submit-btn:hover {
  background: #2c974b;
}

.submit-btn:disabled {
  background: #6a737d;
  cursor: not-allowed;
}

.comments-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.comment-item {
  padding: 1rem;
  background: white;
  border: 1px solid #e1e5e9;
  border-radius: 6px;
}

.comment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.comment-author {
  font-weight: 600;
  color: #24292e;
}

.comment-date {
  color: #586069;
  font-size: 12px;
}

.comment-content {
  color: #24292e;
  line-height: 1.5;
  white-space: pre-wrap;
}

.loading {
  text-align: center;
  color: #586069;
  padding: 2rem;
}

.message {
  padding: 0.75rem;
  margin: 1rem 0;
  border-radius: 6px;
  font-size: 14px;
}

.message-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.message-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.no-comments {
  text-align: center;
  color: #586069;
  padding: 2rem;
  font-style: italic;
}
</style>

<script>
class CommentsManagerDebug {
  constructor() {
    this.postId = document.querySelector('.comments-section').dataset.postId;
    this.postTitle = document.querySelector('.comments-section').dataset.postTitle;
    this.formId = `comment-form-${this.postId.replace(/[^a-zA-Z0-9]/g, '')}`;
    this.listId = `comments-list-${this.postId.replace(/[^a-zA-Z0-9]/g, '')}`;
    this.logElement = document.getElementById('log-content');
    
    this.log('CommentsManager åˆå§‹åŒ–');
    this.log(`Post ID: ${this.postId}`);
    this.log(`Form ID: ${this.formId}`);
    this.log(`List ID: ${this.listId}`);
    
    this.init();
  }

  log(message) {
    const timestamp = new Date().toLocaleTimeString();
    const logMessage = `[${timestamp}] ${message}\n`;
    this.logElement.textContent += logMessage;
    console.log(`[Comments Debug] ${message}`);
  }

  async init() {
    this.log('å¼€å§‹åˆå§‹åŒ–...');
    await this.loadComments();
    this.setupEventListeners();
    this.log('åˆå§‹åŒ–å®Œæˆ');
  }

  async loadComments() {
    this.log('å¼€å§‹åŠ è½½è¯„è®º...');
    try {
      const url = `/.netlify/functions/get-comments?postId=${encodeURIComponent(this.postId)}`;
      this.log(`è¯·æ±‚ URL: ${url}`);
      
      const response = await fetch(url);
      this.log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      this.log(`å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}`);
      
      this.renderComments(result.comments || []);
    } catch (error) {
      this.log(`åŠ è½½è¯„è®ºå¤±è´¥: ${error.message}`);
      console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
      this.showMessage(`åŠ è½½è¯„è®ºå¤±è´¥: ${error.message}`, 'error');
    }
  }

  renderComments(comments) {
    this.log(`æ¸²æŸ“ ${comments.length} æ¡è¯„è®º`);
    const commentsList = document.getElementById(this.listId);
    
    if (!comments || comments.length === 0) {
      commentsList.innerHTML = '<div class="no-comments">è¿˜æ²¡æœ‰è¯„è®ºï¼Œæ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</div>';
      this.log('æ˜¾ç¤ºç©ºè¯„è®ºçŠ¶æ€');
      return;
    }

    commentsList.innerHTML = comments.map(comment => `
      <div class="comment-item">
        <div class="comment-header">
          <span class="comment-author">${this.escapeHtml(comment.author)}</span>
          <span class="comment-date">${new Date(comment.created_at).toLocaleString('zh-CN')}</span>
        </div>
        <div class="comment-content">${this.escapeHtml(comment.content)}</div>
      </div>
    `).join('');
    
    this.log('è¯„è®ºæ¸²æŸ“å®Œæˆ');
  }

  setupEventListeners() {
    this.log('è®¾ç½®äº‹ä»¶ç›‘å¬å™¨...');
    const form = document.getElementById(this.formId);
    if (form) {
      this.log('æ‰¾åˆ°è¡¨å•ï¼Œæ·»åŠ æäº¤äº‹ä»¶ç›‘å¬å™¨');
      form.addEventListener('submit', this.handleSubmit.bind(this));
    } else {
      this.log('é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¡¨å•å…ƒç´ ');
    }
  }

  async handleSubmit(e) {
    e.preventDefault();
    this.log('è¡¨å•æäº¤äº‹ä»¶è§¦å‘');
    
    const form = e.target;
    const submitBtn = form.querySelector('.submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    
    const formData = new FormData(form);
    const commentData = {
      post_id: this.postId,
      post_title: this.postTitle,
      author: formData.get('author').trim(),
      email: formData.get('email').trim(),
      content: formData.get('content').trim(),
      user_agent: navigator.userAgent,
      ip: 'unknown'
    };

    this.log(`æäº¤è¯„è®ºæ•°æ®: ${JSON.stringify(commentData, null, 2)}`);

    try {
      const response = await fetch('/.netlify/functions/add-comment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(commentData)
      });

      this.log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);

      if (response.ok) {
        const result = await response.json();
        this.log(`å“åº”æ•°æ®: ${JSON.stringify(result, null, 2)}`);
        
        if (result.success) {
          this.showMessage('è¯„è®ºå‘è¡¨æˆåŠŸï¼', 'success');
          form.reset();
          await this.loadComments(); // é‡æ–°åŠ è½½è¯„è®º
        } else {
          this.showMessage(result.message || 'è¯„è®ºå‘è¡¨å¤±è´¥', 'error');
        }
      } else {
        const errorData = await response.json();
        this.log(`é”™è¯¯å“åº”: ${JSON.stringify(errorData, null, 2)}`);
        this.showMessage(errorData.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    } catch (error) {
      this.log(`æäº¤è¯„è®ºé”™è¯¯: ${error.message}`);
      console.error('æäº¤è¯„è®ºé”™è¯¯:', error);
      this.showMessage(`æäº¤å¤±è´¥: ${error.message}`, 'error');
    } finally {
      // æ¢å¤æŒ‰é’®çŠ¶æ€
      submitBtn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
    }
  }

  showMessage(message, type) {
    this.log(`æ˜¾ç¤ºæ¶ˆæ¯: ${type} - ${message}`);
    
    // ç§»é™¤ä¹‹å‰çš„æ¶ˆæ¯
    const existingMessages = document.querySelectorAll('.message');
    existingMessages.forEach(msg => msg.remove());

    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    messageDiv.textContent = message;
    
    const commentsSection = document.querySelector('.comments-section');
    commentsSection.insertBefore(messageDiv, commentsSection.firstChild);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
    setTimeout(() => {
      if (messageDiv.parentNode) {
        messageDiv.remove();
      }
    }, 3000);
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
}

// åˆå§‹åŒ–è¯„è®ºç®¡ç†å™¨
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM åŠ è½½å®Œæˆï¼Œæ£€æŸ¥è¯„è®ºç³»ç»Ÿ...');
  if (document.querySelector('.comments-section')) {
    console.log('æ‰¾åˆ°è¯„è®ºåŒºåŸŸï¼Œåˆå§‹åŒ– CommentsManagerDebug');
    new CommentsManagerDebug();
  } else {
    console.log('æœªæ‰¾åˆ°è¯„è®ºåŒºåŸŸ');
  }
});
</script>
