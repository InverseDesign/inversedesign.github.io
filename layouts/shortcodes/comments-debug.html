{{/* Hugo 评论系统短代码 - 调试版本 */}}
<div class="comments-section" data-post-id="{{ .Page.RelPermalink }}" data-post-title="{{ .Page.Title }}">
  <h3>💬 评论 (调试模式)</h3>
  
  <!-- 调试信息 -->
  <div class="debug-info">
    <p><strong>页面信息:</strong></p>
    <ul>
      <li>页面路径: {{ .Page.RelPermalink }}</li>
      <li>页面标题: {{ .Page.Title }}</li>
      <li>表单ID: comment-form-{{ .Page.RelPermalink | md5 }}</li>
      <li>列表ID: comments-list-{{ .Page.RelPermalink | md5 }}</li>
    </ul>
  </div>
  
  <!-- 评论表单 -->
  <div class="comment-form-container">
    <form class="comment-form" id="comment-form-{{ .Page.RelPermalink | md5 }}">
      <div class="form-group">
        <input type="text" name="author" placeholder="您的姓名 *" required>
      </div>
      <div class="form-group">
        <input type="email" name="email" placeholder="您的邮箱 *" required>
      </div>
      <div class="form-group">
        <textarea name="content" placeholder="写下您的评论... *" rows="4" required></textarea>
      </div>
      <button type="submit" class="submit-btn">
        <span class="btn-text">发表评论</span>
        <span class="btn-loading" style="display: none;">发表中...</span>
      </button>
    </form>
  </div>
  
  <!-- 评论列表 -->
  <div class="comments-list" id="comments-list-{{ .Page.RelPermalink | md5 }}">
    <div class="loading">正在加载评论...</div>
  </div>
  
  <!-- 调试日志 -->
  <div class="debug-log" id="debug-log">
    <h4>调试日志</h4>
    <div id="log-content"></div>
  </div>
</div>

<style>
.comments-section {
  margin: 2rem 0;
  padding: 1.5rem;
  border: 1px solid #e1e5e9;
  border-radius: 8px;
  background: #fafbfc;
}

.debug-info {
  background: #e3f2fd;
  padding: 1rem;
  border-radius: 6px;
  margin-bottom: 1rem;
  font-size: 14px;
}

.debug-info ul {
  margin: 0.5rem 0;
  padding-left: 1.5rem;
}

.debug-info li {
  margin: 0.25rem 0;
}

.debug-log {
  margin-top: 2rem;
  padding: 1rem;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  font-family: monospace;
  font-size: 12px;
  max-height: 300px;
  overflow-y: auto;
}

.debug-log h4 {
  margin: 0 0 1rem 0;
  color: #495057;
}

#log-content {
  white-space: pre-wrap;
  line-height: 1.4;
}

.comment-form-container {
  margin-bottom: 2rem;
  padding: 1rem;
  background: white;
  border-radius: 6px;
  border: 1px solid #e1e5e9;
}

.comment-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group input,
.form-group textarea {
  padding: 0.75rem;
  border: 1px solid #d1d5da;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.15s ease-in-out;
}

.form-group input:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #0366d6;
  box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
}

.submit-btn {
  background: #2ea44f;
  color: white;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.15s ease-in-out;
  align-self: flex-start;
}

.submit-btn:hover {
  background: #2c974b;
}

.submit-btn:disabled {
  background: #6a737d;
  cursor: not-allowed;
}

.comments-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.comment-item {
  padding: 1rem;
  background: white;
  border: 1px solid #e1e5e9;
  border-radius: 6px;
}

.comment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.comment-author {
  font-weight: 600;
  color: #24292e;
}

.comment-date {
  color: #586069;
  font-size: 12px;
}

.comment-content {
  color: #24292e;
  line-height: 1.5;
  white-space: pre-wrap;
}

.loading {
  text-align: center;
  color: #586069;
  padding: 2rem;
}

.message {
  padding: 0.75rem;
  margin: 1rem 0;
  border-radius: 6px;
  font-size: 14px;
}

.message-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.message-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.no-comments {
  text-align: center;
  color: #586069;
  padding: 2rem;
  font-style: italic;
}
</style>

<script>
class CommentsManagerDebug {
  constructor() {
    this.postId = document.querySelector('.comments-section').dataset.postId;
    this.postTitle = document.querySelector('.comments-section').dataset.postTitle;
    this.formId = `comment-form-${this.postId.replace(/[^a-zA-Z0-9]/g, '')}`;
    this.listId = `comments-list-${this.postId.replace(/[^a-zA-Z0-9]/g, '')}`;
    this.logElement = document.getElementById('log-content');
    
    this.log('CommentsManager 初始化');
    this.log(`Post ID: ${this.postId}`);
    this.log(`Form ID: ${this.formId}`);
    this.log(`List ID: ${this.listId}`);
    
    this.init();
  }

  log(message) {
    const timestamp = new Date().toLocaleTimeString();
    const logMessage = `[${timestamp}] ${message}\n`;
    this.logElement.textContent += logMessage;
    console.log(`[Comments Debug] ${message}`);
  }

  async init() {
    this.log('开始初始化...');
    await this.loadComments();
    this.setupEventListeners();
    this.log('初始化完成');
  }

  async loadComments() {
    this.log('开始加载评论...');
    try {
      const url = `/.netlify/functions/get-comments?postId=${encodeURIComponent(this.postId)}`;
      this.log(`请求 URL: ${url}`);
      
      const response = await fetch(url);
      this.log(`响应状态: ${response.status} ${response.statusText}`);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();
      this.log(`响应数据: ${JSON.stringify(result, null, 2)}`);
      
      this.renderComments(result.comments || []);
    } catch (error) {
      this.log(`加载评论失败: ${error.message}`);
      console.error('加载评论失败:', error);
      this.showMessage(`加载评论失败: ${error.message}`, 'error');
    }
  }

  renderComments(comments) {
    this.log(`渲染 ${comments.length} 条评论`);
    const commentsList = document.getElementById(this.listId);
    
    if (!comments || comments.length === 0) {
      commentsList.innerHTML = '<div class="no-comments">还没有评论，来发表第一条评论吧！</div>';
      this.log('显示空评论状态');
      return;
    }

    commentsList.innerHTML = comments.map(comment => `
      <div class="comment-item">
        <div class="comment-header">
          <span class="comment-author">${this.escapeHtml(comment.author)}</span>
          <span class="comment-date">${new Date(comment.created_at).toLocaleString('zh-CN')}</span>
        </div>
        <div class="comment-content">${this.escapeHtml(comment.content)}</div>
      </div>
    `).join('');
    
    this.log('评论渲染完成');
  }

  setupEventListeners() {
    this.log('设置事件监听器...');
    const form = document.getElementById(this.formId);
    if (form) {
      this.log('找到表单，添加提交事件监听器');
      form.addEventListener('submit', this.handleSubmit.bind(this));
    } else {
      this.log('错误：找不到表单元素');
    }
  }

  async handleSubmit(e) {
    e.preventDefault();
    this.log('表单提交事件触发');
    
    const form = e.target;
    const submitBtn = form.querySelector('.submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    
    // 显示加载状态
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    
    const formData = new FormData(form);
    const commentData = {
      post_id: this.postId,
      post_title: this.postTitle,
      author: formData.get('author').trim(),
      email: formData.get('email').trim(),
      content: formData.get('content').trim(),
      user_agent: navigator.userAgent,
      ip: 'unknown'
    };

    this.log(`提交评论数据: ${JSON.stringify(commentData, null, 2)}`);

    try {
      const response = await fetch('/.netlify/functions/add-comment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(commentData)
      });

      this.log(`响应状态: ${response.status} ${response.statusText}`);

      if (response.ok) {
        const result = await response.json();
        this.log(`响应数据: ${JSON.stringify(result, null, 2)}`);
        
        if (result.success) {
          this.showMessage('评论发表成功！', 'success');
          form.reset();
          await this.loadComments(); // 重新加载评论
        } else {
          this.showMessage(result.message || '评论发表失败', 'error');
        }
      } else {
        const errorData = await response.json();
        this.log(`错误响应: ${JSON.stringify(errorData, null, 2)}`);
        this.showMessage(errorData.message || '网络错误，请稍后重试', 'error');
      }
    } catch (error) {
      this.log(`提交评论错误: ${error.message}`);
      console.error('提交评论错误:', error);
      this.showMessage(`提交失败: ${error.message}`, 'error');
    } finally {
      // 恢复按钮状态
      submitBtn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
    }
  }

  showMessage(message, type) {
    this.log(`显示消息: ${type} - ${message}`);
    
    // 移除之前的消息
    const existingMessages = document.querySelectorAll('.message');
    existingMessages.forEach(msg => msg.remove());

    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    messageDiv.textContent = message;
    
    const commentsSection = document.querySelector('.comments-section');
    commentsSection.insertBefore(messageDiv, commentsSection.firstChild);
    
    // 3秒后自动移除消息
    setTimeout(() => {
      if (messageDiv.parentNode) {
        messageDiv.remove();
      }
    }, 3000);
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
}

// 初始化评论管理器
document.addEventListener('DOMContentLoaded', () => {
  console.log('DOM 加载完成，检查评论系统...');
  if (document.querySelector('.comments-section')) {
    console.log('找到评论区域，初始化 CommentsManagerDebug');
    new CommentsManagerDebug();
  } else {
    console.log('未找到评论区域');
  }
});
</script>
