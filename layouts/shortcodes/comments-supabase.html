{{/* Hugo 评论系统短代码 - 使用 Supabase */}}
<div class="comments-section" data-post-id="{{ .Page.RelPermalink }}" data-post-title="{{ .Page.Title }}">
  <h3>💬 评论</h3>
  
  <!-- 评论表单 -->
  <div class="comment-form-container">
    <form class="comment-form" id="comment-form-{{ .Page.RelPermalink | md5 }}">
      <div class="form-group">
        <input type="text" name="author" placeholder="您的姓名 *" required>
      </div>
      <div class="form-group">
        <input type="email" name="email" placeholder="您的邮箱 *" required>
      </div>
      <div class="form-group">
        <textarea name="content" placeholder="写下您的评论... *" rows="4" required></textarea>
      </div>
      <button type="submit" class="submit-btn">
        <span class="btn-text">发表评论</span>
        <span class="btn-loading" style="display: none;">发表中...</span>
      </button>
    </form>
  </div>
  
  <!-- 评论列表 -->
  <div class="comments-list" id="comments-list-{{ .Page.RelPermalink | md5 }}">
    <div class="loading">正在加载评论...</div>
  </div>
</div>

<style>
.comments-section {
  margin: 2rem 0;
  padding: 1.5rem;
  border: 1px solid #e1e5e9;
  border-radius: 8px;
  background: #fafbfc;
}

.comments-section h3 {
  margin: 0 0 1.5rem 0;
  color: #24292e;
  font-size: 1.25rem;
}

.comment-form-container {
  margin-bottom: 2rem;
  padding: 1rem;
  background: white;
  border-radius: 6px;
  border: 1px solid #e1e5e9;
}

.comment-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group input,
.form-group textarea {
  padding: 0.75rem;
  border: 1px solid #d1d5da;
  border-radius: 6px;
  font-size: 14px;
  transition: border-color 0.15s ease-in-out;
}

.form-group input:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #0366d6;
  box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
}

.submit-btn {
  background: #2ea44f;
  color: white;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background-color 0.15s ease-in-out;
  align-self: flex-start;
}

.submit-btn:hover {
  background: #2c974b;
}

.submit-btn:disabled {
  background: #6a737d;
  cursor: not-allowed;
}

.comments-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.comment-item {
  padding: 1rem;
  background: white;
  border: 1px solid #e1e5e9;
  border-radius: 6px;
}

.comment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}

.comment-author {
  font-weight: 600;
  color: #24292e;
}

.comment-date {
  color: #586069;
  font-size: 12px;
}

.comment-content {
  color: #24292e;
  line-height: 1.5;
  white-space: pre-wrap;
}

.loading {
  text-align: center;
  color: #586069;
  padding: 2rem;
}

.message {
  padding: 0.75rem;
  margin: 1rem 0;
  border-radius: 6px;
  font-size: 14px;
}

.message-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.message-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.no-comments {
  text-align: center;
  color: #586069;
  padding: 2rem;
  font-style: italic;
}

@media (max-width: 768px) {
  .comments-section {
    padding: 1rem;
  }
  
  .comment-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.25rem;
  }
}
</style>

<script>
class CommentsManager {
  constructor() {
    this.postId = document.querySelector('.comments-section').dataset.postId;
    this.postTitle = document.querySelector('.comments-section').dataset.postTitle;
    this.formId = `comment-form-${this.postId.replace(/[^a-zA-Z0-9]/g, '')}`;
    this.listId = `comments-list-${this.postId.replace(/[^a-zA-Z0-9]/g, '')}`;
    this.supabaseUrl = '{{ .Site.Params.supabase.url }}';
    this.supabaseKey = '{{ .Site.Params.supabase.anonKey }}';
    this.init();
  }

  async init() {
    await this.loadComments();
    this.setupEventListeners();
  }

  async loadComments() {
    try {
      const response = await fetch(`/.netlify/functions/get-comments?postId=${encodeURIComponent(this.postId)}`);
      
      if (!response.ok) {
        throw new Error('Failed to load comments');
      }
      
      const result = await response.json();
      this.renderComments(result.comments || []);
    } catch (error) {
      console.error('加载评论失败:', error);
      this.showMessage('加载评论失败，请刷新页面重试', 'error');
    }
  }

  renderComments(comments) {
    const commentsList = document.getElementById(this.listId);
    
    if (!comments || comments.length === 0) {
      commentsList.innerHTML = '<div class="no-comments">还没有评论，来发表第一条评论吧！</div>';
      return;
    }

    commentsList.innerHTML = comments.map(comment => `
      <div class="comment-item">
        <div class="comment-header">
          <span class="comment-author">${this.escapeHtml(comment.author)}</span>
          <span class="comment-date">${new Date(comment.created_at).toLocaleString('zh-CN')}</span>
        </div>
        <div class="comment-content">${this.escapeHtml(comment.content)}</div>
      </div>
    `).join('');
  }

  setupEventListeners() {
    const form = document.getElementById(this.formId);
    if (form) {
      form.addEventListener('submit', this.handleSubmit.bind(this));
    }
  }

  async handleSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('.submit-btn');
    const btnText = submitBtn.querySelector('.btn-text');
    const btnLoading = submitBtn.querySelector('.btn-loading');
    
    // 显示加载状态
    submitBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    
    const formData = new FormData(form);
    const commentData = {
      post_id: this.postId,
      post_title: this.postTitle,
      author: formData.get('author').trim(),
      email: formData.get('email').trim(),
      content: formData.get('content').trim(),
      user_agent: navigator.userAgent,
      ip: 'unknown' // 服务器端会获取真实IP
    };

    try {
      const response = await fetch('/.netlify/functions/add-comment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(commentData)
      });

      if (response.ok) {
        const result = await response.json();
        if (result.success) {
          this.showMessage('评论发表成功！', 'success');
          form.reset();
          await this.loadComments(); // 重新加载评论
        } else {
          this.showMessage(result.message || '评论发表失败', 'error');
        }
      } else {
        const errorData = await response.json();
        this.showMessage(errorData.message || '网络错误，请稍后重试', 'error');
      }
    } catch (error) {
      console.error('提交评论错误:', error);
      this.showMessage('提交失败，请检查网络连接', 'error');
    } finally {
      // 恢复按钮状态
      submitBtn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
    }
  }

  showMessage(message, type) {
    // 移除之前的消息
    const existingMessages = document.querySelectorAll('.message');
    existingMessages.forEach(msg => msg.remove());

    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    messageDiv.textContent = message;
    
    const commentsSection = document.querySelector('.comments-section');
    commentsSection.insertBefore(messageDiv, commentsSection.firstChild);
    
    // 3秒后自动移除消息
    setTimeout(() => {
      if (messageDiv.parentNode) {
        messageDiv.remove();
      }
    }, 3000);
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
}

// 初始化评论管理器
document.addEventListener('DOMContentLoaded', () => {
  if (document.querySelector('.comments-section')) {
    new CommentsManager();
  }
});
</script>
